<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>多功能日曆</title>
  <link href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    :root {
      --work-color: #b2fba5;
      --holiday-color: #ff8a80;
      --bg-color: #f7f0ff;
      --font-color: #333;
    }
    body {
      background-color: var(--bg-color);
      color: var(--font-color);
      font-family: 'Segoe UI', sans-serif;
    }
    .calendar-container {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      padding: 1rem;
    }
    .calendar-day {
      background-color: white;
      border-radius: 6px;
      padding: 6px;
      height: 100px;
      overflow-y: auto;
      position: relative;
      cursor: pointer;
    }
    .calendar-day.work { background-color: var(--work-color); }
    .calendar-day.holiday { background-color: var(--holiday-color); }
    .calendar-day .date { font-weight: bold; }
    .note { margin-top: 4px; font-size: 12px; background: #eee; padding: 2px; border-radius: 4px; }
  </style>
</head>
<body>
  <section class="section">
    <div class="container">
      <div class="level">
        <div class="level-left">
          <div>
            <p class="title">📅 多功能日曆</p>
            <p id="today-display"></p>
            <p id="weather-display"></p>
          </div>
        </div>
        <div class="level-right">
          <button class="button is-danger" onclick="logout()">登出</button>
        </div>
      </div>

      <div class="field is-grouped">
        <div class="control">
          <div class="select">
            <select id="year-select"></select>
          </div>
        </div>
        <div class="control">
          <div class="select">
            <select id="month-select"></select>
          </div>
        </div>
        <div class="control">
          <button class="button is-link" onclick="renderCalendar()">切換月份</button>
        </div>
      </div>

      <div class="calendar-container" id="calendar"></div>
    </div>
  </section>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC6vdUNMsL1q9M5Yx8W-KuHC3H-tCGL0eY",
      authDomain: "my-diary-app-6eb1e.firebaseapp.com",
      projectId: "my-diary-app-6eb1e",
      storageBucket: "my-diary-app-6eb1e.appspot.com",
      messagingSenderId: "1027204805080",
      appId: "1:1027204805080:web:52446129ee5d06e25242ad"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        setupSelectors();
        renderCalendar();
        document.getElementById('today-display').textContent = '今日：' + new Date().toLocaleDateString();
        fetchWeather();
      } else {
        auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
      }
    });

    function logout() {
      auth.signOut();
    }

    function setupSelectors() {
      const ysel = document.getElementById('year-select');
      const msel = document.getElementById('month-select');
      const year = new Date().getFullYear();
      ysel.innerHTML = '';
      for (let y = year - 5; y <= year + 5; y++) {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y + '年';
        if (y === year) opt.selected = true;
        ysel.appendChild(opt);
      }
      msel.innerHTML = '';
      for (let m = 0; m < 12; m++) {
        const opt = document.createElement('option');
        opt.value = m;
        opt.textContent = (m + 1) + '月';
        if (m === new Date().getMonth()) opt.selected = true;
        msel.appendChild(opt);
      }
    }

    function renderCalendar() {
      const year = parseInt(document.getElementById('year-select').value);
      const month = parseInt(document.getElementById('month-select').value);
      const calendar = document.getElementById('calendar');
      calendar.innerHTML = '';

      const firstDay = new Date(year, month, 1).getDay();
      const totalDays = new Date(year, month + 1, 0).getDate();

      for (let i = 0; i < firstDay; i++) {
        const empty = document.createElement('div');
        calendar.appendChild(empty);
      }

      for (let d = 1; d <= totalDays; d++) {
        const dateStr = `${year}-${(month+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
        const cell = document.createElement('div');
        cell.className = 'calendar-day';
        cell.innerHTML = `<div class='date'>${d}</div><div class='notes'></div>`;
        calendar.appendChild(cell);

        db.collection('calendars').doc(currentUser.uid).collection('events').doc(dateStr).get().then(doc => {
          if (doc.exists) {
            const data = doc.data();
            const notesDiv = cell.querySelector('.notes');
            cell.classList.add(data.type === 'holiday' ? 'holiday' : 'work');
            data.notes?.forEach((note, i) => {
              const div = document.createElement('div');
              div.className = 'note';
              div.textContent = `${note.time} ${note.text}`;
              div.onclick = e => {
                e.stopPropagation();
                const newText = prompt('修改內容：', note.text);
                if (newText === null) return;
                data.notes[i].text = newText;
                db.collection('calendars').doc(currentUser.uid).collection('events').doc(dateStr).set(data);
                renderCalendar();
              };
              notesDiv.appendChild(div);
            });
          } else {
            cell.classList.add('work');
          }
        });

        cell.onclick = () => {
          const time = prompt('時間（例如 14:00）：');
          const text = prompt('輸入活動內容：');
          if (!text) return;
          const type = confirm('是否設為放假日？') ? 'holiday' : 'work';
          db.collection('calendars').doc(currentUser.uid).collection('events').doc(dateStr).get().then(doc => {
            let notes = doc.exists && doc.data().notes ? doc.data().notes : [];
            notes.push({ time, text });
            db.collection('calendars').doc(currentUser.uid).collection('events').doc(dateStr).set({ type, notes });
            renderCalendar();
          });
        };
      }
    }

    function fetchWeather() {
      navigator.geolocation?.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`)
          .then(res => res.json())
          .then(data => {
            const w = data.current_weather;
            document.getElementById('weather-display').textContent = `天氣：${w.temperature}°C，濕度 ${w.relative_humidity || '?'}%`;
          });
      });
    }
  </script>
</body>
</html>
